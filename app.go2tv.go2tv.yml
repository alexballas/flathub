app-id: app.go2tv.go2tv
runtime: org.freedesktop.Platform
runtime-version: "23.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
command: go2tv

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --device=dri
  - --env=PATH=/app/bin:/usr/bin # Override path and ensure we use the bundled ffmpeg version.
  - --filesystem=host

build-options:
  env:
    - GOBIN=/app/bin
    - GOROOT=/usr/lib/sdk/golang

modules:
  - name: "x264"
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: http://download.videolan.org/x264/snapshots/x264-snapshot-20191217-2245-stable.tar.bz2
        sha256: b2495c8f2930167d470994b1ce02b0f4bfb24b3317ba36ba7f112e9809264160

  - name: fdk-aac
    config-opts:
      - --enable-shared
    sources:
      - type: archive
        url: https://github.com/mstorsjo/fdk-aac/archive/v2.0.3.tar.gz
        sha256: e25671cd96b10bad896aa42ab91a695a9e573395262baed4e4a2ff178d6a3a78

      - type: script
        dest-filename: autogen.sh
        commands:
          - autoreconf -fiv

  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --enable-nonfree
      - --enable-libx264
      - --enable-libfdk-aac
      - --enable-encoder=libx264
      - --enable-encoder=libfdk_aac
      - --enable-decoder=h264
      - --enable-decoder=aac
      - --enable-muxer=flv
      - --enable-muxer=mov
      - --enable-demuxer=mov
      - --enable-demuxer=mp4
      - --enable-protocol=pipe
      - --enable-protocol=file
      - --enable-filter=format
      - --enable-ffprobe
      - --disable-debug
      - --disable-doc
      - --disable-ffplay
      - --enable-shared
      - --disable-static
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-7.1.tar.xz
        sha256: 40973d44970dbc83ef302b0609f2e74982be2d85916dd2ee7472d30678a7abe6
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/ffmpeg/examples
      - "*.la"
      - "*.a"

  - name: go2tv
    buildsystem: simple
    build-commands:
      - $GOROOT/bin/go build -trimpath -ldflags="-s -w" -o go2tv cmd/go2tv/go2tv.go
      - install -Dm00755 go2tv $FLATPAK_DEST/bin/go2tv
      - install -Dm00644 assets/linux/$FLATPAK_ID.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -Dm00644 assets/linux/$FLATPAK_ID.appdata.xml $FLATPAK_DEST/share/appdata/$FLATPAK_ID.appdata.xml
      - install -Dm00644 assets/go2tv-icon-desktop-512.png $FLATPAK_DEST/share/icons/hicolor/512x512/apps/$FLATPAK_ID.png
    sources:
      - type: git
        url: "https://github.com/alexballas/go2tv"
        commit: 1a34b30f307a3e465bb7ce995961abec6dd26f27
      - go.mod.yml